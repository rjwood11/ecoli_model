"0",""
"0","sites_millcreek = c(""03431060"", ""03430550"", ""03431083"",""03431000"")"
"0","sites_harpeth = c(""0343233905"", ""03432400"", ""034324146"",""03432800"", ""03434500"", ""03433500"",""03432350"")"
"0","sites_richland = c(""03431700"", ""03431655"")"
"0","parameter_codes = c(""00060"", ""00300"")"
"0",""
"0",""
"0","sites = readNWISsite(siteNumbers=c(sites_millcreek, sites_harpeth, sites_richland))"
"0","site_coords = sites[c(2:3,5:6,7:8,11:13),]"
"0","data.table::setnames(site_coords, old = c(""dec_lat_va""),"
"0","                     new = c(""Latitude""))"
"0","data.table::setnames(site_coords, old = c(""dec_long_va""),"
"0","                     new = c(""Longitude""))"
"0",""
"0","# Just 0343233905 to demonstrate concept"
"0",""
"0","today_data = readNWISdata(sites=c('0343233905','03431000','03431060','03431655','03431700','03432800','03433500','03434500','03432350'), service=""iv"",asDateTime=T)"
"0","                          "
"0","#today_data = readNWISdata(sites=c('0343233905'), service=""iv""))"
"0","                          "
"0",""
"0",""
"0",""
"0","today=today_data %>% "
"0","  group_by(site_no) %>%"
"0","  slice(which.max(as.POSIXct(dateTime,format = '%Y-%m-%d %H:%M:%S')))"
"0",""
"0",""
"0",""
"0",""
"0",""
"0","# discharge often unavailable, annoying."
"0","# todo: figure out a way to approximate, average over prior year values on the same day?"
"0",""
"0","#names(today)"
"0",""
"0","Codelist<-vapply(strsplit(names(today)[c(4,6,8,10,12,14,16,18)],""_""), `[`, 2, FUN.VALUE=character(1))"
"0",""
"0",""
"0","#PcodeLookup<-function(x) { "
"0"," # return(pCodeToName[pCodeToName$parm_cd==x,description]) "
"0","#}"
"0",""
"0",""
"0","#Codelist1<-for (i in 1:8) {"
"0"," # Pcode[[i]][2]"
"0","#} "
"0",""
"0","#data.table::setnames(today, old = Codelist, new = pCodeToName$description,skip_absent=T)"
"0",""
"0","names(today)[c(4,6,8,10,12,14,16,18)]<- pCodeToName$characteristicname[match(as.numeric(names(today)[c(4,6,8,10,12,14,16,18)]), pCodeToName$parm_cd)]"
"0",""
"0","url = ""https://www.wunderground.com/precipitation/us/tn/franklin/35.92,-86.86?cm_ven=localwx_modprecip"""
"0","source = readLines(url, encoding = ""UTF-8"",warn=F)"
"0","parsed_doc = htmlParse(source, encoding = ""UTF-8"")"
"0","PRCP = xpathSApply(parsed_doc, path =""/html/body/app-root/app-precipitation/one-column-layout/wu-header/sidenav/mat-sidenav-container/mat-sidenav-content/div/section/div[2]/div[2]/div[1]/lib-precipitation-liquid-accumulation/div/div/div/div[1]/div/div[2]/div[2]/div/span[2]/text()"", xmlValue)"
"0",""
"0",""
"0","url = ""https://www.wunderground.com/weather/us/tn/franklin/35.92,-86.86"""
"0","source = readLines(url, encoding = ""UTF-8"",warn=F)"
"0","parsed_doc = htmlParse(source, encoding = ""UTF-8"")"
"0","TAVG = xpathSApply(parsed_doc, path = ""/html/body/app-root/app-today/one-column-layout/wu-header/sidenav/mat-sidenav-container/mat-sidenav-content/div/section/div[3]/div[1]/div/div[1]/div[1]/lib-city-current-conditions/div/div[2]/div/div/div[2]/lib-display-unit/span/span[1]"", xmlValue)"
"0",""
"0",""
"0","url = ""https://www.wunderground.com/weather/us/tn/franklin/35.92,-86.86"""
"0","source = readLines(url,encoding = ""UTF-8"",warn=F)"
"0","parsed_doc = htmlParse(source, encoding = ""UTF-8"")"
"0","WSF5 <- xpathSApply(parsed_doc, path = '/html/body/app-root/app-today/one-column-layout/wu-header/sidenav/mat-sidenav-container/mat-sidenav-content/div/section/div[3]/div[1]/div/div[1]/div[1]/lib-city-current-conditions/div/div[3]/div/div[2]/p/strong/lib-display-unit/span/span[1]', xmlValue)"
"0","# river.flow.cfs = Discharge column in the USGS data"
"0","# SINDOY = sin(day of the year; 1-365)"
"0","# DO = Dissolved Oxygen"
"0",""
"0","# I have it set up to only do 0343233905 as a demo, todo: reorganize data structure from data pulling and"
"0","# merge with the site_coords table so the mutate statement will calc all stations and leave no data as null"
"0",""
"0","#################### START HERE"
"0",""
"0","#site_coords = site_coords %>% mutate(ecoli = if_else(site_no == '0343233905', sqrt(as.numeric(precip)) + tail(today_data$river_flow_cfs, n=1) + tail(today_data$dissolved_oxygen, n=1)^2 + sin(as.numeric(strftime(time, format = ""%j"")))^2, runif(8,100,400)))"
"0",""
"0",""
"0","## Need to figure out how to run multiple distinct models"
"0",""
"0","###########################################################################################################"
"0","# Predictive Equations from Virtual Beach "
"0","## Hwy 100 Sampling Location - MLR"
"0","## Ecoli = -136 + 6468*(PRCP) + 1.416*(discharge) "
"0","## Decision Criteria = 235"
"0",""
"0","## Lowhead Dam/Lewisburg Pike - GBM"
"0","## Ecoli = PRCP + TAVG + SQUARE(WSF5) + discharge                      -24.56 + 5.799*(discharge)"
"0","## Decision Criteria = 528.8                                            235"
"0",""
"0","## Richland Creek/Sylvan Park - MLR"
"0","## Ecoli = -1201 + 1.912e+04*(PRCP) + 0.2474*(SQUARE(TAVG))"
"0","## Decision Criteria = 235"
"0",""
"0","###########################################################################################################"
"0",""
"0","#Lat<-site_coords[c(1:9),7]"
"0","#Long<-site_coords[c(1:9),8]"
"0",""
"0","#today$Latitude<-Lat"
"0","#today$Longitude<-Long"
"0",""
"0",""
"0","today1<-today"
"0",""
"0","site_no<-c(""03433500"",""03433500"",""03433500"",""03432350"",""03433500"",""03434500"",""03431700"","
"0","           ""03431700"",""03431060"",""03431060"",""0343233905"")"
"0",""
"0","Location<-c(""Natchez Trace"", ""Moran Rd. Bridge"", ""Hwy 100 Boat Launch"", ""Lowhead Dam"",  ""Coley Davis"", ""Hwy 70"",            "
"0","            ""Richland Creek"",""Jackson Blvd"",   ""Whitsett Park"", ""Mill Creek Greenway"", ""Lewisburg Pike"")"
"0",""
"0","LocLookup <- data.frame(Location, site_no)"
"0",""
"0","Forecast1<-LocLookup"
"0",""
"0","Forecast<-merge(x = Forecast1, y = today1, by = ""site_no"", all.y = TRUE, na.rm=T)"
"0",""
"0","Forecast <- Forecast[-c(1,4,9),]"
"0","#Long<-site_coords[c(1:5,7:9),8]"
"0",""
"0","Lat<-c('36.08160', '36.11757',  '36.15122', '36.10167',  '35.89984', '36.01722', '36.05456', '36.12200')"
"0",""
"0","Long<-c('-86.68073', '-86.71905', '-86.85427','-86.86806',   '-86.84289', '-86.89972', '-86.92851', '-87.09889')"
"0",""
"0","Forecast$Latitude<-Lat"
"0","Forecast$Longitude<-Long"
"0",""
"0",""
"0",""
"0","#Forecast$Longitude <- site_coords$Longitude[match(as.numeric(Forecast$Location), pCodeToName$parm_cd)]"
"0",""
"0",""
"0",""
"0",""
"0","###################################################################################################################################################"
"0",""
"0","###   Calculate E.coli Predictions based on Virtual Beach Equations   ###"
"0",""
"0","###################################################################################################################################################"
"0",""
"0","a<- Forecast$Location"
"0","b<-as.numeric(PRCP)"
"0","c<-as.numeric(TAVG)"
"0","d<-as.numeric(WSF5)"
"0","e<-Forecast$`Stream flow, mean. daily`"
"0","z<- as.numeric(strftime(time, format = ""%j""))"
"0",""
"0",""
"0","ecoli <- numeric(length = length(a))"
"0",""
"0","for (i in seq_along(a)){"
"0","if (a[i]==""Richland Creek"") {"
"0","    ecoli[i]= -1201 + as.numeric(1.912e+04*(b)) + 0.2474*(c^2)"
"0","} else if (a[i]==""Lewisburg Pike"") {"
"0","    ecoli[i]= -24.56 + 5.799*e[i]"
"0","} else if (a[i]==""Hwy 100 Boat Launch"") {"
"0","    ecoli[i]= -136 + 6468*(b) + 1.416*e[i] "
"0","} else {ecoli[i] <- NA}"
"0","}"
"0",""
"0","Forecast$ecoli<-signif(ecoli,3)"
"0","Forecast$Precipitation<-as.numeric(PRCP)"
"0",""
"0","# assign color values based on conditional ecoli values"
"0",""
"0","Forecast = Forecast %>% mutate(Status = ifelse(ecoli > 235, ""Warning"", "
"0","                                                    ifelse(ecoli < 235 & ecoli > 175, ""Caution"", ""Safe"")))"
"0",""
"0","#site_coords = site_coords %>% mutate(Status = ifelse(ecoli > 235, ""Warning"", "
"0","#                                                    ifelse(ecoli < 235 & ecoli > 175, ""Caution"", ""Safe"")))"
"0",""
"0",""
"0","# Set NA values to gray"
"0",""
"0","Forecast$Status[is.na(Forecast$Status)] = NA"
"0",""
"0","#site_coords$Status[is.na(site_coords$Status)] = 'Data Unavailable'"
"0",""
"0","cols = c(""Safe"" = ""green"", ""Warning"" = ""red"", ""Caution"" = ""yellow"", ""Data Unavailable"" = ""gray"")"
"0",""
"0",""
"0","#Lat<-site_coords[c(1:5,7:9),7]"
"0","#Long<-site_coords[c(1:5,7:9),8]"
"0",""
"0","#Forecast$Latitude<-Lat"
"0","#Forecast$Longitude<-Long"
"0",""
"0",""
"0",""
